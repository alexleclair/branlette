// Generated by CoffeeScript 1.6.3
(function(){var e,t,n=this;t=function(e){var t;t="";t=e.replace(/[^\\]'/g,function(e,t,n){return e.slice(0,1)+"\\'"});return"'"+t+"'"};e={io:null,redis:require("redis"),redisWorker:null,fs:null,httpServer:null,express:null,config:{port:8080,redisHost:"localhost",redisPort:6379,redisKey:"noel:dev:",wwwPath:"./static/",updateRedisTimer:5e3,labels:{acolyte:"Acolyte Communication",akufen:"Akufen",braque:"Agence Braque",alfred:"Alfred info",amazone:"Amazone communications gestion",amuse:"Amuse/Lowe Roche",bcp:"BCP",beauchemin:"Beauchemin",bbr:"Bleublancrouge",bob:"Bob",brad:"Brad",cap:"Cap Communication",carat:"Carat",cart1er:"CART1ER",gccom:"CGCOM",cossette:"Cossette",coutu:"Coutu Communication",cri:"CRI",cundari:"Cundari",defi:"Défi marketing",dentsubos:"DentsuBos",desarts:"DesArts Communication",draft:"Draftfcb",ecorce:"Écorce",egzakt:"Egzakt",em:"EM L'agence",espacem:"Espace M",gendron:"Gendron Communication",generation:"Génération",gvm:"Groupe GVM",aod:"Group Média AOD",hop:"HOP comportement de marque",jazz:"Jazz Marketing Communications",jwt:"JWT",kabane:"Kabane",kbsp:"kbs+p",lesaint:"Le saint publicité et design",lemieux:"Lemieux Bédard",dompteurs:"Les Dompteurs de souris",evades:"Les Évadés",lg2:"lg2",marketel:"Marketel",martel:"Martel et compagnie",mediaexperts:"Media Experts",mediavation:"Mediavation",merlicom:"Merlicom",minimal:"Minimal Médias",morrow:"Morrow",nolin:"Nolin BBDO",nurun:"Nurun",ogilvy:"Ogilvy Montréal",orangetango:"orangetango",otis:"Otis Léger Marketing",oui:"Oui Marketing",palm:"PALM + HAVAS",pheromone:"Phéromone",publicis:"Publicis",republik:"Republik",reservoir:"Réservoir Publicité Conseil",ressac:"Ressac",revolver3:"revolver3",svyr:"Saint-Jacques Vallée Y&R",sidlee:"Sid Lee",tamtam:"TAM-TAM\\TBWA",tank:"TANK",taxi:"TAXI",tequila:"Tequila communication et marketing",terrain:"Terrain marketing",tonik:"Tonik Groupimage",touche:"Touché! PHD",tp1:"TP1",trinergie:"Trinergie",uber:"Über",upperkut:"Upperkut",wasabi:"Wasabi Communications",youville:"Youville Communauté Créative",zip:"ZiP communication",imedia:"Imédia"}},agencies:{},siblings:{},sockets:{},connCounter:0,init:function(t){var n,r,i,s=this;t!=null&&(this.config=this._mergeOptions(this.config(t)));process.argv.length>2&&(this.config.port=process.argv[2]);this.fs=require("fs");n=require("express");this.express=n.call(this);this.httpServer=require("http").createServer(this.express);this.httpServer.listen(this.config.port);this.io=require("socket.io").listen(this.httpServer);this.io.set("log level",1);this.express.get("/api/*",this._handleAPICalls);this.express.post("/api/*",this._handleAPICalls);this.express.get("/*",this._handleHttpRequest);this.express.use(n.bodyParser());this.express.use(function(e,t,n,r){console.error(e.stack);return n.send(500,"Oops ! Something went super wrong.")});this.redisWorker=this.redis.createClient(e.config.redisPort,e.config.redisHost);for(r in e.config.labels){console.log("Fetching data for "+r);i=function(t){return s.redisWorker.get(e.config.redisKey+"agency:"+t,function(n,r){var i;i=r;i==null&&(i=0);return e.agencies[t]={count:i,people:0}})};i(r)}setInterval(this._saveScores,this.config.updateRedisTimer);return this.io.on("connection",function(t){var n;++e.connCounter;n=e.generateCode(e.connCounter);console.log("Code is"+n);e.siblings[n]=[];e.sockets[t.id]=t;t.set("code",n);e.attachSiblings(t,n);t.emit("code",n);t.emit("labels",e.config.labels);t.emit("agencies",e.agencies);t.on("pick",function(n){return t.get("agency",function(r,i){r==null&&i!=null&&e.agencies[i]!=null&&e.agencies[i].people--;if(e.agencies[n]!=null){t.set("agency",n);console.log("setting +1 on agency "+n,e.agencies[n]);e.agencies[n].people++;console.log("set +1 on agency "+n,e.agencies[n])}e.sendToSiblings(t,"pick",n);return e.sendAgencies()})});t.on("shake",function(n){n==null&&(n=null);if(n!=null&&e.agencies[n]!=null){e.agencies[n].count++;e.sendAgencies()}else t.get("agency",function(t,n){if(t==null&&n!=null&&e.agencies[n]!=null){e.agencies[n].count++;return e.sendAgencies()}});return e.sendToSiblings(t,"shake",n)});t.on("registerSibling",function(n){console.log("INVITED",n);t.set("code",n);e.attachSiblings(t,n);return e.sendToSiblings(t,"siblingsCount",e.siblings[n].length)});return t.on("disconnect",function(){t.get("agency",function(t,n){if(t==null&&n!=null&&e.agencies[n]!=null){e.agencies[n].people--;return e.sendAgencies()}});t.get("code",function(n,r){var i;if(r!=null){i=e.siblings[r].indexOf(t.id);i>=0&&e.siblings[r].splice(i,1);if(e.siblings[r].length===0)return delete e.siblings[r]}});return delete e.sockets[t.id]})})},attachSiblings:function(t,n){if(e.siblings!=null&&e.siblings[n]&&e.siblings[n].indexOf(n)<0)return e.siblings[n].push(t.id)},sendToSiblings:function(t){var n,r,i,s;n=[];for(r=i=1,s=arguments.length;1<=s?i<s:i>s;r=1<=s?++i:--i)n.push(arguments[r]);return t.get("code",function(t,i){var s,o,u,a;if(e.siblings[i]!=null){a=[];for(r=o=0,u=e.siblings[i].length;0<=u?o<u:o>u;r=0<=u?++o:--o)try{s=e.siblings[i][r];if(e.sockets[s]!=null){console.log("Sent to "+s);n.length===1?a.push(e.sockets[s].emit(n[0])):n.length>=2?a.push(e.sockets[s].emit(n[0],n[1])):a.push(void 0)}else a.push(void 0)}catch(f){t=f;a.push(console.log("[error] ",t.message,t))}return a}})},generateCode:function(e){return(e+1e3).toString(36)},sendAgencies:function(){return e.io.sockets.emit("agencies",e.agencies)},_handleAPICalls:function(t,n){var r,i,s;s=t.url.split("?")[0].split("/");if(s.length<4){n.writeHead("500");n.end("API calls expect at least a module/parameter combo.");return}i=s[2];r=s[3];switch(i){case"stats":n.setHeader("Content-Type","application/json");n.send(JSON.stringify(e.agencies));return!1;default:n.writeHead("404");return n.end("Module "+i+" not found")}},_saveScores:function(){var t,n;n=[];for(t in e.agencies)n.push(e.redisWorker.set(e.config.redisKey+"agency:"+t,e.agencies[t].count,function(e,t){}));return n},_saveEvent:function(t,n){return e.redisWorker.zadd(["clowntriste:events",(new Date).getTime(),JSON.stringify(t)],function(e,t){return n(t)})},_handleHttpRequest:function(t,n){var r,i;r=t.url.split("?")[0];r=r==="/"?"index.html":r;r=r.split("..").join("");i=__dirname+"/"+e.config.wwwPath+r;return e.fs.readFile(i,function(e,t){if(e){n.writeHead("500");return n.end("Error loading "+r)}n.writeHead("200");return n.end(t)})}};e.init()}).call(this);